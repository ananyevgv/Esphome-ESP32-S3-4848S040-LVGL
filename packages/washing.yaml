#-------------------------------------------
#packages:
#  washing: !include 
#    file: packages/display/washing.yaml 
#    vars:
#      remaining_time: sensor.washing_machine_remaining_time
#      washing_machine: sensor.washing_machine 
#      wash_cycle: sensor.wash_cycle_status
#      collor_off: 0xB6B6B6
#      collor_on: 0x0000ff
#      collor_err: 0xff0000
#      disp_percent: 0 # 100 x


substitutions:
  icons_temperature: "\U000F0510" #  F03C8  mdi:coolant-temperature F10C3  mdi:thermometer-low
  icons_spin:        "\U000F0464"  # F0453  mdi:reload F0D4E  mdi:axis-x-rotate-clockwise
  icons_time:        "\U000F1AE1" #F051B mdi:timer-outline

#-------------------------------------------
# FONT
#-------------------------------------------
font:
  - file: "font/DSEG7ModernMini-Bold.ttf"
    id: SEG20
    glyphs: ${number_characters}
    size: 20
    bpp: 4  
    extras:
      - file: 'font/materialdesignicons-webfont.ttf' # http://materialdesignicons.com/cdn/7.4.47/ 
        glyphs: [
          $icons_temperature,
          $icons_spin,
          $icons_time
        ]  
    
  - file: "gfonts://Roboto"
    id: washing_font
    size: 20
    bpp: 4
    glyphs: ${characters}
    
#-------------------------------------------
# IMAGE
#-------------------------------------------
image:
  - file: "picture/washing_transparent.png"
    id: image_washing
    resize: 450x450
    type: RGB565
    transparency:  alpha_channel #chroma_key 
    
#-------------------------------------------
# SCRIPT
#-------------------------------------------
script:
  - id: off_collor_cp
    then:
      - lvgl.widget.update:
          id: washing_cp_1
          line_color: $collor_off
      - lvgl.widget.update:
          id: washing_cp_2
          line_color: $collor_off
      - lvgl.widget.update:
          id: washing_cp_3
          line_color: $collor_off
      - lvgl.widget.update:
          id: washing_cp_4
          line_color: $collor_off
      - lvgl.widget.update:
          id: washing_cp_5
          line_color: $collor_off
      - lvgl.widget.update:
          id: washing_cp_6
          line_color: $collor_off          
      - lvgl.widget.update:
          id: washing_cp_7
          line_color: $collor_off          
      - lvgl.widget.update:
          id: washing_cp_8
          line_color: $collor_off          
          
  - id: on_collor_cp
    then:
        - if:
            condition:
              lambda: 'return id(program).state == 1;'
            then:
              - lvgl.widget.update:
                  id: washing_cp_1
                  line_color: $collor_on
        - if:
            condition:
              lambda: 'return id(program).state == 2;'
            then:
              - lvgl.widget.update:
                  id: washing_cp_2
                  line_color: $collor_on        
        - if:
            condition:
              lambda: 'return id(program).state == 3;'
            then:
              - lvgl.widget.update:
                  id: washing_cp_3
                  line_color: $collor_on                     
        - if:
            condition:
              lambda: 'return id(program).state == 4;'
            then:
              - lvgl.widget.update:
                  id: washing_cp_4
                  line_color: $collor_on
        - if:
            condition:
              lambda: 'return id(program).state == 5;'
            then:
              - lvgl.widget.update:
                  id: washing_cp_5
                  line_color: $collor_on        
        - if:
            condition:
              lambda: 'return id(program).state == 6;'
            then:
              - lvgl.widget.update:
                  id: washing_cp_6
                  line_color: $collor_on        
        - if:
            condition:
              lambda: 'return id(program).state == 7;'
            then:
              - lvgl.widget.update:
                  id: washing_cp_7
                  line_color: $collor_on        
        - if:
            condition:
              lambda: 'return id(program).state == 8;'
            then:
              - lvgl.widget.update:
                  id: washing_cp_8
                  line_color: $collor_on   

  - id: off_collor_ps
    then:
      - lvgl.widget.update:
          id: washing_ps_1
          line_color: $collor_off
      - lvgl.widget.update:
          id: washing_ps_2
          line_color: $collor_off
      - lvgl.widget.update:
          id: washing_ps_3
          line_color: $collor_off
      - lvgl.widget.update:
          id: washing_ps_4
          line_color: $collor_off 
        
  - id: on_collor_ps
    then:
      - if:
          condition:
            lambda: 'return id(washing_program_state).state == "Отжим";'
          then:
            - lvgl.widget.update:
                id: washing_ps_2
                line_color: $collor_on
      - if:
          condition:
            lambda: 'return id(washing_program_state).state == "Отжим - Ночной";'
          then:
            - lvgl.widget.update:
                id: washing_ps_2
                line_color: $collor_on          
      - if:
          condition:
            lambda: 'return id(washing_program_state).state == "Пар";'
          then:
            - lvgl.widget.update:
                id: washing_ps_4
                line_color: $collor_on          
      - if:
          condition:
            lambda: 'return id(washing_program_state).state == "Предвар. стирка";'
          then:
            - lvgl.widget.update:
                id: washing_ps_3
                line_color: $collor_on  
      - if:
          condition:
            lambda: 'return id(washing_program_state).state == "Стирка";'
          then:
            - lvgl.widget.update:
                id: washing_ps_3
                line_color: $collor_on        
      - if:
          condition:
            lambda: 'return id(washing_program_state).state == "Полоскание";'
          then:
            - lvgl.widget.update:
                id: washing_ps_3
                line_color: $collor_on     
      - if:
          condition:
            lambda: 'return id(washing_program_state).state == "Посл. полоскание";'
          then:
            - lvgl.widget.update:
                id: washing_ps_3
                line_color: $collor_on   
      - if:
          condition:
            lambda: 'return id(washing_program_state).state == "Сушка";'
          then:
            - lvgl.widget.update:
                id: washing_ps_1
                line_color: $collor_on   
            
      - if:
          condition:
            lambda: 'return id(washing_program_state).state == "выкл";'
          then:
            - script.execute: off_collor_cp
            - lvgl.widget.update:
                id: washing_rc
                line_color: $collor_off
            - lvgl.label.update:
                id: d_washing_time
                text_color: $collor_off
            - lvgl.label.update:
                id: d_washing_spin
                text_color: $collor_off
            - lvgl.label.update:
                id: d_washing_temperature
                text_color: $collor_off
            - lvgl.label.update:
                id: d_washing_program_state
                text_color: $collor_off

            - lvgl.arc.update:
                id: arc_washing_percent
                value: 0

  - id: off_collor_ms
    then:
      - lvgl.widget.update:
          id: washing_ms_0
          line_color: $collor_off
      - lvgl.widget.update:
          id: washing_ms_1
          line_color: $collor_off
      - lvgl.widget.update:
          id: washing_ms_2
          line_color: $collor_off
          
  - id: on_collor_ms
    then:
      - if:
          condition:
            lambda: 'return id(washing_machine_state).state == "Бездействие";'
          then:
            - lvgl.widget.update:
                id: washing_ms_0
                line_color: $collor_on
      - if:
          condition:
            lambda: 'return id(washing_machine_state).state == "Работает";'
          then:
            - lvgl.widget.update:
                id: washing_ms_0
                line_color: $collor_on
            - lvgl.widget.update:
                id: washing_ms_1
                line_color: $collor_on
      - if:
          condition:
            lambda: 'return id(washing_machine_state).state == "Пауза";'
          then:
            - lvgl.widget.update:
                id: washing_ms_0
                line_color: $collor_on
            - lvgl.widget.update:
                id: washing_ms_2
                line_color: $collor_on
      - if:
          condition:
            lambda: 'return id(washing_machine_state).state == "Выбор отложенного запуска";'
          then:
            - lvgl.widget.update:
                id: washing_ms_0
                line_color: $collor_on
            - lvgl.widget.update:
                id: washing_ms_1
                line_color: $collor_on    
            - lvgl.widget.update:
                id: washing_ms_2
                line_color: $collor_on       
      - if:
          condition:
            lambda: 'return id(washing_machine_state).state == "Задан отложенный запуск";'
          then:
            - lvgl.widget.update:
                id: washing_ms_0
                line_color: $collor_on
            - lvgl.widget.update:
                id: washing_ms_1
                line_color: $collor_on    
            - lvgl.widget.update:
                id: washing_ms_2
                line_color: $collor_on     
      - if:
          condition:
            lambda: 'return id(washing_machine_state).state == "Ошибка";'
          then:
            - lvgl.widget.update:
                id: washing_ms_0
                line_color: $collor_err
            - lvgl.widget.update:
                id: washing_ms_1
                line_color: $collor_err    
            - lvgl.widget.update:
                id: washing_ms_2
                line_color: $collor_err
      - if:
          condition:
            lambda: 'return id(washing_machine_state).state == "Завершено";'
          then:
            - lvgl.widget.update:
                id: washing_ms_0
                line_color: $collor_on
            - lvgl.widget.update:
                id: washing_ms_1
                line_color: $collor_on    
            - lvgl.widget.update:
                id: washing_ms_2
                line_color: $collor_on

#-------------------------------------------
# SENSOR
#-------------------------------------------
sensor:
# сенсор выбранной программы
  - platform: homeassistant
    id: program
    entity_id: sensor.washing_machine
    attribute: program
    filters:
      - filter_out: nan
    on_value:
      then:
        - script.execute: off_collor_cp
        - script.execute: on_collor_cp
      
# сенсор температуры           
  - platform: homeassistant
    id: temperature
    entity_id: sensor.washing_machine
    attribute: temperature
    unit_of_measurement: °C
    state_class: measurement
    device_class: temperature
    filters:
      - filter_out: nan
    on_value:
      - lvgl.label.update:
          id: d_washing_temperature
          text: 
            format: "$icons_temperature %.0f"
            args: x  
          text_color: $collor_on 
          
# сенсор скорости отжима
  - platform: homeassistant
    id: spin_speed
    entity_id: sensor.washing_machine
    attribute: spin_speed
    filters:
      - filter_out: nan
    on_value:
      - lvgl.label.update:
          id: d_washing_spin
          text: 
            format: "$icons_spin%.0f"
            args: x  
          text_color: $collor_on 
          

# процент выполнения стирки ?????
  - platform: homeassistant
    id: fill_percent
    entity_id: sensor.washing_machine
    attribute: fill_percent
    filters:
      - filter_out: nan
    on_value:
      - lvgl.arc.update:
          id: arc_washing_percent
          value: !lambda |- 
            return $disp_percent;  
            
# сенсор  код программы ?     
  - platform: homeassistant
    id: program_code
    entity_id: sensor.washing_machine
    attribute: program_code
    
# сенсор стадия выполнения программы
  - platform: homeassistant
    id: wash_cycle
    entity_id: $wash_cycle
    
# сенсор оставшегося времени стирки атрибут
  - platform: homeassistant
    id: remaining_minutes
    entity_id: sensor.washing_machine
    attribute: remaining_minutes
    unit_of_measurement: min
    device_class: duration
    filters:
      - filter_out: nan
    on_value:
      - lvgl.label.update:
          id: d_washing_time
          text: 
            format: "$icons_time %02.0f:%02.0f"
            args:  ["trunc(id(remaining_minutes).state / 60)", "trunc(fmod(id(remaining_minutes).state , 60.0))"]  
          text_color: $collor_on
      - lvgl.label.update:
          id: display_washing_time
          text: 
            format: "%02.0f:%02.0f"
            args:  ["trunc(id(remaining_minutes).state / 60)", "trunc(fmod(id(remaining_minutes).state , 60.0))"] 
          text_color: white  

# сенсор оставшегося времени стирки
  - platform: homeassistant
    id: remaining_time
    entity_id: $remaining_time

#-------------------------------------------
# Binary sensor
#-------------------------------------------
binary_sensor:
  - platform: homeassistant
    id: remote_control
    entity_id: $washing_machine
    attribute: remote_control
    on_press:
      lvgl.widget.update:
          id: washing_rc
          line_color: $collor_on
    on_release:
      lvgl.widget.update:
          id: washing_rc
          line_color: $collor_off

#-------------------------------------------
# TEXT_SENSOR
#-------------------------------------------
text_sensor:
# состояние стиральной машины
  - platform: homeassistant
    id: washing_machine_state
    entity_id: sensor.washing_machine
    filters:      
      - substitute:
        - "Idle -> Бездействие" 
        - "Running -> Работает" 
        - "Pause -> Пауза" 
        - "Delayed start selection -> Выбор отложенного запуска"
        - "Delayed start programmed -> Задан отложенный запуск" 
        - "Error -> Ошибка"  
        - "Finished -> Завершено"  
        - "unavailable -> выкл"
        - "None -> выкл"
    on_value:
      then:
        - script.execute: off_collor_ms
        - script.execute: on_collor_ms
        
# стадия выполнения программы
  - platform: homeassistant
    id: washing_program_state
    entity_id: $wash_cycle
    filters:      
      - substitute:
        - "Stopped -> Остановлено" 
        - "Pre-wash -> Предвар. стирка" 
        - "Wash -> Стирка"
        - "Rinse -> Полоскание" 
        - "Last rinse -> Посл. полоскание"
        - "End -> Конец"
        - "Drying -> Сушка"
        - "Error -> Ошибка"
        - "Steam -> Пар"
        - "Spin - Good Night -> Отжим - Ночной"
        - "Spin -> Отжим"
        - "unavailable -> выкл"
        - "None -> выкл"
    on_value:
      then:
        - script.execute: off_collor_ps
        - lvgl.label.update:
            id: d_washing_program_state
            text: !lambda return x;
            text_color: $collor_on
        - script.execute: on_collor_ps

#-------------------------------------------
# LVGL
#-------------------------------------------
lvgl:
  pages:
    - id: !extend weather
# Добавляем на weather стиралку
      widgets:
        - button:
            y: 40 #60
            x: -5
            align: TOP_RIGHT
            bg_opa: TRANSP
            shadow_opa: TRANSP
           # shadow_spread: 2
           # shadow_width: 25
           # shadow_opa: 100%
           # shadow_color: color_blue
            width: 120
            height: 70
            widgets:  
              - label:
                  align: CENTER
                  id: display_washing_time
                  text: 88:88
                  text_font: SEG20
                  text_color: 0x808080
                  y: -5
            on_press:
              lvgl.page.show: washing_page

# отображение статуса стиральной машины   
    - id: washing_page
      bg_color: 0x000000
      scrollbar_mode: "OFF"
      scrollable: false
      widgets:
        - line:
            points:
              - 210, 50
              - 270, 50
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_ms_0
            
        - line:
            points:
              - 270, 150
              - 300, 150
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_ms_1
     
        - line:
            points:
              - 300, 150
              - 330, 150
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_ms_2
            
# отображение выбранной  программы        
        - line:
            points:
              - 290, 70
              - 350, 70
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_cp_1
            
        - line:
            points:
              - 350, 120
              - 420, 120
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_cp_2  
            
        - line:
            points:
              - 390, 190
              - 450, 190
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_cp_3
            
        - line:
            points:
              - 390, 260
              - 450, 260
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_cp_4         
            
        - line:
            points:
              - 350, 340
              - 400, 340
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_cp_5          
           
        - line:
            points:
              - 290, 380
              - 350, 380
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_cp_6
            
        - line:   
            points:
              - 210, 400
              - 270, 400
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_cp_7
            
        - line:   
            points:
              - 130, 380
              - 190, 380
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_cp_8  

# отображение выполнения  программы      
        - line:
            points:
              - 70, 340
              - 130, 340
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_ps_1 
 
        - line:
            points:
              - 30, 260
              - 90, 260
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_ps_2  
 
        - line:
            points:
              - 30, 190
              - 90, 190
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_ps_3
            
        - line:
            points:
              - 70, 120
              - 130, 120
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_ps_4
            
##################################  
        - line:
            points:
              - 140, 150
              - 220, 150
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: line_washing_15 # сет
            
##################################     
# отображение удаленного управления    
        - line:
            points:
              - 130, 70
              - 190, 70
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_rc #
 
        - line:
            points:
              - 170, 320
              - 300, 320
            line_width: 60
            line_color: $collor_off
            line_rounded: false   
            id: washing_pc # zoom
            
        - obj:
            bg_color: $collor_off
            width: 260 
            height: 70
            align: CENTER 
            scrollbar_mode: "OFF"
            scrollable: false
            y: -15
            widgets:
              - label:
                  y: -5
                  align: TOP_LEFT
                  text: 88:88
                  text_font: SEG20
                  text_color: $collor_off
                  id: d_washing_time
              - label:
                  y: 5
                  align: BOTTOM_LEFT
                  text: 0123456789012345678901
                  text_font: washing_font
                  text_color: $collor_off
                  id: d_washing_program_state

              - label:
                  y: -5
                  align: TOP_RIGHT
                  text: 1888
                  text_font: SEG20
                  text_color: $collor_off
                  id: d_washing_spin
              - label:
                  y: 5
                  align: BOTTOM_RIGHT
                  text: 88
                  text_font: SEG20
                  text_color: $collor_off
                  id: d_washing_temperature

           
##############################################################################
        - image:
            align: CENTER
            y: -15
            src: image_washing
          #  bg_color: 0x000000
          #  bg_image_opa: 100% 
##############################################################################   
        - arc:
            id: arc_washing_percent
            y: -15
            align: CENTER
            arc_width: 20
            width: 445
            height: 445
            min_value: 0
            max_value: 100
            start_angle: 0
            end_angle: 360
            rotation: 90
            value: 100    
            indicator:
              arc_width: 20

     