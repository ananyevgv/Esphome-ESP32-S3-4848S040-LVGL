#############################################################################
#----Страничка vacuum -------------------------------------------------------
#############################################################################
# Add yaml and copy file esphome/packages/
#packages:
#  vacuum: !include 
#    file: packages/display/vacuum_cleaner.yaml
#    vars:
#      background_vacuum: back6

#      vacuum_robot: vacuum.robot_pylesos
#      cleaned_area_entity: sensor.robot_pylesos_current_clean_area
      
#      dirty: sensor.robot_pylesos_sensor_dirty_left
#      main_brush: sensor.robot_pylesos_main_brush_left
#      filter: sensor.robot_pylesos_filter_left
#      side_brush: sensor.robot_pylesos_side_brush_left
      
#      reset_side_brush:  button.robot_pylesos_reset_side_brush
#      reset_dirty: button.robot_pylesos_reset_sensor_dirty
#      reset_main_brush: button.robot_pylesos_reset_main_brush
#      reset_filter: button.robot_pylesos_reset_filter
#
#############################################################################

#########################
#     #     #     #     #
#side #     #     #start#
#     #     #     #     #
#########################
#     #           #     #
#dirty#           # stop#
#     #           #     #
#######  vacuum   #######
#     #           #     #
#filt #           #pause#
#     #           #     #
#########################
#     #     #     #     #
#main #home #     # spot#
#     #     #     #     #
#########################

substitutions:
  vacuum_icons_map:           "\U000F034E"   # map-marker
  vacuum_icons_start:         "\U000F040A"   # Play
  #vacuum_icons:               "\U000F070D"   # robot-vacuum
  vacuum_icons_stop:          "\U000F04DB"   # stop
  vacuum_icons_pause:         "\U000F03E4"  # pause
  vacuum_icons_home:          "\U000F0F9C"  # home-import-outline
  vacuum_icons_clean_spot:    "\U000F0A77" #
  vacuum_icons_fan:           "\U000F0210" #fan
  
  vacuum_icons_air_filter:    "\U000F0D43"  # air-filter
  vacuum_icons_dirty:         "\U000F06D0"  # eye-outline
  vacuum_icons_main_brush:    "\U000F00E2"  # broom
  vacuum_icons_side_brush:    "\U000F00E3"  # brush

#-------------------------------------------
# FONT
#-------------------------------------------
font:
  - file: 'font/materialdesignicons-webfont.ttf' # http://materialdesignicons.com/cdn/7.4.47/ 
    id: vacuum_48
    size: 48
    bpp: 4
    glyphs: [
      $vacuum_icons_map,
      $vacuum_icons_start,
      $vacuum_icons_stop,
      $vacuum_icons_pause,
      $vacuum_icons_clean_spot,
      $vacuum_icons_home,
      $vacuum_icons_fan,
      $vacuum_icons_air_filter,
      $vacuum_icons_dirty,
      $vacuum_icons_main_brush,
      $vacuum_icons_side_brush
    ]      
    
  - file: "gfonts://Roboto"
    id: vacuum_24
    size: 24
    bpp: 4 
    glyphs: |-
      %².0123456789 абвгдеёжзийклмнопрстуфхцчщьыъэюя

#-------------------------------------------
# IMAGE
#-------------------------------------------   
image:
  - file: "picture/vacuum.png"
    id: vacuum_image
    type: rgb565
    resize: 160x160
    transparency: alpha_channel
    
  - file: "picture/vacuum_brush.png"
    id: vacuum_brush_image
    type: rgb565
    resize: 50x50
    transparency: alpha_channel
    
#-------------------------------------------
# INTERVAL
#-------------------------------------------
interval:
  - interval: 0.1s
    then:
      - if:
          condition:
            lambda: 'return id(vacuum_state).state == "уборка";'
          then:
            - lvgl.image.update:
                id: vacuum_brush_state_image
                angle: !lambda |-
                  static int vacuum = 0;
                  vacuum=vacuum+30;
                  return (vacuum);    
      - if:
          condition:
            lambda: 'return id(vacuum_state).state == "на базе";'
          then:
            - lvgl.widget.show:
                id: vacuum_docked
          else:
            - lvgl.widget.hide:
                id: vacuum_docked

#-------------------------------------------
# SENSOR
#-------------------------------------------
sensor:
  - platform: homeassistant
    id: battery_level_sensor
    entity_id: "${vacuum_robot}"
    attribute: battery_level
    filters:
      - filter_out: nan
    on_value: 
      - lvgl.label.update:
          id: battery_level_label
          text: 
            format: "%.0f%%"
            args: ["x"]
            
  - platform: homeassistant
    id: sensor_cleaned_area_entity
    entity_id: "${cleaned_area_entity}"
    filters:
      - filter_out: nan
    on_value:      
      - lvgl.label.update:
          id: cleaned_area_entity_label
          text: 
            format: "%.0fм²"
            args: ["x"]
            
            
  - platform: homeassistant
    id: sensor_dirty
    entity_id: "${dirty}"
    filters:
      - filter_out: nan
    on_value: 
      - lvgl.label.update:
          id: dirty_label
          text: 
            format: " %.0f ч"
            args: ["x/3600"]   

  - platform: homeassistant
    id: sensor_main_brush
    entity_id: "${main_brush}"
    filters:
      - filter_out: nan
    on_value: 
      - lvgl.label.update:
          id: main_brush_label
          text: 
            format: " %.0f ч"
            args: ["x/3600"]   
            
  
  - platform: homeassistant
    id: sensor_filter
    entity_id: "${filter}"
    filters:
      - filter_out: nan
    on_value: 
      - lvgl.label.update:
          id: filter_label
          text: 
            format: " %.0f ч"
            args: ["x/3600"]   
            
  - platform: homeassistant
    id: sensor_side_brush
    entity_id: "${side_brush}"
    filters:
      - filter_out: nan
    on_value: 
      - lvgl.label.update:
          id: side_brush_label
          text: 
            format: " %.0f ч"
            args: ["x/3600"]        


#-------------------------------------------
# TEXT SENSOR
#-------------------------------------------
text_sensor:             
  - platform: homeassistant
    entity_id: "${vacuum_robot}"
    id: vacuum_state
    filters:
      - substitute:
        - "docked -> на базе" 
        - "cleaning -> уборка" 
        - "returning -> возврат на базу"
        - "paused -> пауза" 
        - "idle -> бездействие"
        - "nan -> не в сети"
    on_value:
      then:
         - lvgl.label.update:
            id: vacuum_state_label
            text: !lambda |- 
              return x;    
              
  - platform: homeassistant
    entity_id: "${vacuum_robot}"
    attribute: fan_speed
    id: fan_speed
    on_value:
      - lvgl.dropdown.update:
          id: d_fan_speed
          selected_text:  !lambda |- 
            return x; 

#-------------------------------------------
# LVGL
#-------------------------------------------
lvgl:
  pages:
    - id: vacuum_page     
      width: 100%
      bg_color: 0x000000
      bg_opa: cover
      widgets:
        - image:
            align: CENTER
            src: $background_vacuum
        - obj:
            bg_opa: TRANSP
            border_opa: TRANSP
            width: 480
            height: 460
            align: TOP_LEFT
            layout:
              pad_row: 10
              pad_column: 10
              type: GRID
              grid_columns: [FR(1), FR(1), FR(1), FR(1)]
              grid_rows: [FR(1), FR(1), FR(1), FR(1)]
            widgets:
            ######################## 
            #Сбросить боковую щетку
              - button:
                  checkable: false
                  grid_cell_row_pos: 0 #Позиция ряд
                  grid_cell_column_pos: 0 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 1 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label:
                        text_font: vacuum_48
                        align: center
                        text: $vacuum_icons_side_brush
                        y: -20
                    - label:
                        align: center
                        text: " "
                        text_font: vacuum_24
                        y: 20
                        id: side_brush_label
                  on_long_press:
                    - homeassistant.action:
                        action: button.press
                        data:
                          entity_id: "${reset_side_brush}"
                          
            # Сбросить датчик загрязнения
              - button:
                  checkable: false
                  grid_cell_row_pos: 1 #Позиция ряд
                  grid_cell_column_pos: 0 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 1 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label:
                        text_font: vacuum_48
                        align: center
                        text: $vacuum_icons_dirty
                        y: -20
                    - label:
                        align: center
                        text: " "
                        text_font: vacuum_24
                        y: 20
                        id: dirty_label
                  on_long_press:
                    - homeassistant.action:
                        action: button.press
                        data:
                          entity_id: "${reset_dirty}"
                          
            # Сбросить основную щетку
              - button:
                  checkable: false
                  grid_cell_row_pos: 2 #Позиция ряд
                  grid_cell_column_pos: 0 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 1 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label:
                        text_font: vacuum_48
                        align: center
                        text: $vacuum_icons_main_brush
                        y: -20
                    - label:
                        align: center
                        text: " "
                        text_font: vacuum_24
                        y: 20
                        id: main_brush_label
                  on_long_press:
                    - homeassistant.action:
                        action: button.press
                        data:
                          entity_id: "${reset_main_brush}"                        
                          
            # Сбросить боковую щетку
              - button:
                  checkable: false
                  grid_cell_row_pos: 3 #Позиция ряд
                  grid_cell_column_pos: 0 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 1 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label:
                        text_font: vacuum_48
                        align: center
                        text: $vacuum_icons_air_filter
                        y: -20
                    - label:
                        align: center
                        text: " "
                        text_font: vacuum_24
                        y: 20
                        id: filter_label
                  on_long_press:
                    - homeassistant.action:
                        action: button.press
                        data:
                          entity_id: "${reset_filter}"               

            #Старт
              - button:
                  checkable: false
                  grid_cell_row_pos: 0 #Позиция ряд
                  grid_cell_column_pos: 3 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 1 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label:
                        align: center
                        text: $vacuum_icons_start
                        text_font: vacuum_48
                  on_click:
                    - homeassistant.action:
                        action: vacuum.start
                        data:
                          entity_id: "${vacuum_robot}"

            #Стоп
              - button:
                  checkable: false
                  grid_cell_row_pos: 1 #Позиция ряд
                  grid_cell_column_pos: 3 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 1 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label:
                        align: center
                        text: $vacuum_icons_stop
                        text_font: vacuum_48
                  on_click:
                    - homeassistant.action:
                        action: vacuum.stop
                        data:
                          entity_id: "${vacuum_robot}"
            #Пауза
              - button:
                  checkable: false
                  grid_cell_row_pos: 2 #Позиция ряд
                  grid_cell_column_pos: 3 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 1 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label:
                        align: center
                        text: $vacuum_icons_pause
                        text_font: vacuum_48
                  on_click:
                    - homeassistant.action:
                        action: vacuum.pause
                        data:
                          entity_id: "${vacuum_robot}"         
                          
            #Местная уборка
              - button:
                  checkable: false
                  grid_cell_row_pos: 3 #Позиция ряд
                  grid_cell_column_pos: 3 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 1 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label:
                        align: center
                        text: $vacuum_icons_clean_spot
                        text_font: vacuum_48
                  on_click:
                    - homeassistant.action:
                        action: vacuum.clean_spot
                        data:
                          entity_id: "${vacuum_robot}"   
                          
            #На зарядку
              - button:
                  checkable: false
                  grid_cell_row_pos: 3 #Позиция ряд
                  grid_cell_column_pos: 1 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 1 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label:
                        align: center
                        text: $vacuum_icons_home
                        text_font: vacuum_48
                  on_click:
                    - homeassistant.action:
                        action: vacuum.return_to_base
                        data:
                          entity_id: "${vacuum_robot}"   
                          
            #Найти
              - button:
                  checkable: false
                  grid_cell_row_pos: 3 #Позиция ряд
                  grid_cell_column_pos: 2 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 1 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label:
                        align: center
                        text: $vacuum_icons_map
                        text_font: vacuum_48
                  on_click:
                    - homeassistant.action:
                        action: vacuum.locate
                        data:
                          entity_id: "${vacuum_robot}"                  

            #Мощность       
              - obj:
                  bg_opa: TRANSP
                  shadow_opa: TRANSP
                  border_opa: TRANSP
                  border_width: 0
                  grid_cell_row_pos: 0 #Позиция ряд
                  grid_cell_column_pos: 1 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 1 #Занять ячеек в ряде
                  grid_cell_column_span: 2 #Занять ячеек в колонке
                  widgets:
                    - label:
                        align: LEFT_MID
                        text_font: vacuum_48
                        text: "${vacuum_icons_fan}"
                    - dropdown:
                        id: d_fan_speed
                        x: 50
                        align: LEFT_MID
                        bg_opa: TRANSP
                        shadow_opa: TRANSP
                        border_opa: TRANSP
                        border_width: 0
                        options:
                          - Silent
                          - Standard
                          - Medium
                          - Turbo
                          - Gentle
                          - Auto
                        selected_index: 1
                        dropdown_list:
                          selected:
                            checked:
                              text_color: 0xFF0000
                        on_change:
                          - homeassistant.action:
                              action: vacuum.set_fan_speed
                              data:
                                entity_id: "${vacuum_robot}"
                                fan_speed: !lambda |- 
                                  switch (x) {
                                    case 0: return "Silent"; break;
                                    case 1: return "Standard"; break;
                                    case 2: return "Medium"; break;              
                                    case 3: return "Turbo"; break;      
                                    case 4: return "Gentle"; break;              
                                    case 5: return "Auto"; break; 
                                    default: return "Standard";
                                  }
          #vacuum
              - button:
                  checkable: false
                  grid_cell_row_pos: 1 #Позиция ряд
                  grid_cell_column_pos: 1 #Позиция колонка
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  grid_cell_row_span: 2 #Занять ячеек в ряде
                  grid_cell_column_span: 2 #Занять ячеек в колонке
                  bg_opa: 35%
                  widgets:
                    - label: 
                        id: battery_level_label
                        align: top_left
                        text: "%"  
                        text_font: vacuum_24
                    - label: 
                        id: cleaned_area_entity_label
                        align: top_right
                        text: "м²"  
                        text_font: vacuum_24
                    - label: 
                        id: vacuum_state_label
                        align: bottom_mid
                        text: " "
                        text_font: vacuum_24
                    - image:
                        id: vacuum_brush_state_image
                        align: center
                        src: vacuum_brush_image
                        y: -50
                        x: 30
                    - image:
                        id: vacuum_state_image
                        align: center
                        src: vacuum_image
                    - led:
                       align: top_mid
                       color: 0xffffff
                       bg_color: 0x00000
                       y: 5
                       width: 70
                       height: 25   
                       id: vacuum_docked
                  on_click:
                    - if:
                        condition:
                          lambda: 'return id(vacuum_state).state == "cleaning";'
                        then:
                          - homeassistant.action:
                              action: vacuum.pause
                              data:
                                entity_id: "${vacuum_robot}"
                        else:
                          - homeassistant.action:
                              action: vacuum.start
                              data:
                                entity_id: "${vacuum_robot}"
                                
